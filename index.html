<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Finanzas Personales</title>
    <base target="_self">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@preline/preline@2.0.0/dist/preline.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bogota: '#0033A0',
                        nequi: '#00B5E2',
                        daviplata: '#FF6B00',
                        colpatria: '#E31937',
                        bolsillo: '#6CC24A',
                        efectivo: '#FFD700',
                        otros: '#A45DB6',
                    }
                }
            }
        }
    </script>
    <style>
        .bank-card {
            transition: all 0.3s ease;
        }
        .bank-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-full">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">Control Financiero Personal</h1>
            <p class="text-gray-600 dark:text-gray-300">Administra tus ingresos, gastos y transferencias entre cuentas</p>
        </header>

        <!-- Bank Balances Section -->
        <section class="mb-10">
            <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">Saldos Bancarios</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Cards will be generated by JavaScript -->
            </div>
        </section>

        <!-- Charts Section -->
        <section class="mb-10 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <h3 class="text-lg font-medium text-gray-700 dark:text-gray-200 mb-4">Distribución de Fondos</h3>
                <canvas id="fundsDistributionChart" height="300"></canvas>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <h3 class="text-lg font-medium text-gray-700 dark:text-gray-200 mb-4">Ingresos vs Gastos</h3>
                <canvas id="incomeExpenseChart" height="300"></canvas>
            </div>
        </section>

        <!-- Summary Section -->
        <section class="mb-10 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg shadow p-4">
                <h3 class="text-lg font-medium text-green-800 dark:text-green-200 mb-2">Ingresos Totales</h3>
                <p class="text-2xl font-bold text-green-600 dark:text-green-300" id="totalIncome">$0</p>
            </div>
            <div class="bg-red-50 dark:bg-red-900/20 rounded-lg shadow p-4">
                <h3 class="text-lg font-medium text-red-800 dark:text-red-200 mb-2">Gastos Totales</h3>
                <p class="text-2xl font-bold text-red-600 dark:text-red-300" id="totalExpenses">$0</p>
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg shadow p-4">
                <h3 class="text-lg font-medium text-blue-800 dark:text-blue-200 mb-2">Balance Total</h3>
                <p class="text-2xl font-bold text-blue-600 dark:text-blue-300" id="totalBalance">$0</p>
            </div>
        </section>

        <!-- Bank Reconciliation Section -->
        <section class="mb-10 bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">Conciliación Bancaria</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Banco</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Saldo Registrado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Saldo Real</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Descuadre</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="reconciliationBody">
                        <!-- Rows will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-end">
                <button id="calculateDiscrepancy" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                    Calcular Descuadre
                </button>
            </div>
        </section>

        <!-- Transaction History Section -->
        <section class="mb-10 bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Historial de Movimientos</h2>
                <div class="flex space-x-2">
                    <select id="filterBank" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                        <option value="">Todos los bancos</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                    <select id="filterType" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                        <option value="">Todos los tipos</option>
                        <option value="income">Ingreso</option>
                        <option value="expense">Gasto</option>
                        <option value="transfer">Transferencia</option>
                    </select>
                    <select id="filterCategory" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                        <option value="">Todas las categorías</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Banco</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Categoría</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Descripción</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Valor</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="transactionHistory">
                        <!-- Rows will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Transaction Forms Section -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Income Form -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">Registrar Ingreso</h2>
                <form id="incomeForm" class="space-y-4">
                    <div>
                        <label for="incomeBank" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Banco</label>
                        <select id="incomeBank" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" required>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label for="incomeAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Valor</label>
                        <input type="number" id="incomeAmount" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" placeholder="Ej: 1000000" required>
                    </div>
                    <div>
                        <label for="incomeDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descripción</label>
                        <input type="text" id="incomeDescription" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" placeholder="Ej: Pago de nómina" required>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">
                        Registrar Ingreso
                    </button>
                </form>
            </div>

            <!-- Expense Form -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">Registrar Gasto</h2>
                <form id="expenseForm" class="space-y-4">
                    <div>
                        <label for="expenseBank" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Banco</label>
                        <select id="expenseBank" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" required>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label for="expenseAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Valor</label>
                        <input type="number" id="expenseAmount" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" placeholder="Ej: 50000" required>
                    </div>
                    <div>
                        <label for="expenseCategory" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Categoría</label>
                        <select id="expenseCategory" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" required>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label for="expenseDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descripción</label>
                        <input type="text" id="expenseDescription" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" placeholder="Ej: Almuerzo con clientes">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                        Registrar Gasto
                    </button>
                </form>
            </div>

            <!-- Transfer Form -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">Transferir Fondos</h2>
                <form id="transferForm" class="space-y-4">
                    <div>
                        <label for="fromBank" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Banco Origen</label>
                        <select id="fromBank" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" required>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label for="toBank" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Banco Destino</label>
                        <select id="toBank" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" required>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label for="transferAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Valor</label>
                        <input type="number" id="transferAmount" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" placeholder="Ej: 200000" required>
                    </div>
                    <div>
                        <label for="transferDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descripción</label>
                        <input type="text" id="transferDescription" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" placeholder="Ej: Transferencia para ahorros">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition">
                        Realizar Transferencia
                    </button>
                </form>
            </div>
        </section>
    </div>

    <script>
        // Initial Data
        const banks = [
            { id: 'bogota', name: 'Banco de Bogotá', balance: 5000000, color: 'bogota', icon: 'fa-building-columns' },
            { id: 'nequi', name: 'Nequi', balance: 1500000, color: 'nequi', icon: 'fa-mobile-screen' },
            { id: 'daviplata', name: 'Daviplata', balance: 800000, color: 'daviplata', icon: 'fa-wallet' },
            { id: 'colpatria', name: 'Colpatria', balance: 2500000, color: 'colpatria', icon: 'fa-credit-card' },
            { id: 'bolsillo', name: 'Bolsillo', balance: 300000, color: 'bolsillo', icon: 'fa-piggy-bank' },
            { id: 'otros', name: 'Otros Ingresos', balance: 0, color: 'otros', icon: 'fa-money-bill-transfer' },
            { id: 'efectivo', name: 'Efectivo', balance: 500000, color: 'efectivo', icon: 'fa-money-bill-wave' }
        ];

        const expenseCategories = [
            'Transporte', 'Comida', 'Vivienda', 'Entretenimiento', 
            'Salud', 'Educación', 'Ropa', 'Servicios', 'Otros'
        ];

        let transactions = [
            { id: 1, date: '2023-06-01', type: 'income', bank: 'bogota', amount: 3000000, description: 'Pago nómina', category: '' },
            { id: 2, date: '2023-06-02', type: 'expense', bank: 'nequi', amount: 45000, description: 'Almuerzo', category: 'Comida' },
            { id: 3, date: '2023-06-03', type: 'expense', bank: 'daviplata', amount: 25000, description: 'Taxi', category: 'Transporte' },
            { id: 4, date: '2023-06-04', type: 'transfer', fromBank: 'bogota', toBank: 'nequi', amount: 500000, description: 'Envío a Nequi', category: '' },
            { id: 5, date: '2023-06-05', type: 'income', bank: 'otros', amount: 200000, description: 'Venta artículo', category: '' }
        ];

        // DOM Elements
        const bankCardsContainer = document.querySelector('.grid-cols-1.sm\\:grid-cols-2.lg\\:grid-cols-3.xl\\:grid-cols-4');
        const reconciliationBody = document.getElementById('reconciliationBody');
        const transactionHistory = document.getElementById('transactionHistory');
        const filterBank = document.getElementById('filterBank');
        const filterType = document.getElementById('filterType');
        const filterCategory = document.getElementById('filterCategory');
        const incomeBank = document.getElementById('incomeBank');
        const expenseBank = document.getElementById('expenseBank');
        const fromBank = document.getElementById('fromBank');
        const toBank = document.getElementById('toBank');
        const expenseCategory = document.getElementById('expenseCategory');
        const incomeForm = document.getElementById('incomeForm');
        const expenseForm = document.getElementById('expenseForm');
        const transferForm = document.getElementById('transferForm');
        const calculateDiscrepancy = document.getElementById('calculateDiscrepancy');
        const totalIncomeElement = document.getElementById('totalIncome');
        const totalExpensesElement = document.getElementById('totalExpenses');
        const totalBalanceElement = document.getElementById('totalBalance');

        // Charts
        let fundsDistributionChart, incomeExpenseChart;

        // Initialize the application
        function init() {
            renderBankCards();
            renderBankOptions();
            renderExpenseCategories();
            renderReconciliationTable();
            renderTransactionHistory();
            updateSummary();
            initCharts();
            setupEventListeners();
        }

        // Render bank cards
        function renderBankCards() {
            bankCardsContainer.innerHTML = '';
            banks.forEach(bank => {
                const card = document.createElement('div');
                card.className = `bank-card bg-${bank.color}-100 dark:bg-gray-700 rounded-lg shadow p-4 flex items-center justify-between fade-in`;
                card.innerHTML = `
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-${bank.color}-500 text-white mr-3">
                            <i class="fas ${bank.icon}"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-700 dark:text-gray-200">${bank.name}</h3>
                            <p class="text-2xl font-bold text-${bank.color}-600 dark:text-${bank.color}-300">${formatCurrency(bank.balance)}</p>
                        </div>
                    </div>
                    <div class="text-${bank.color}-500">
                        <i class="fas fa-ellipsis-vertical"></i>
                    </div>
                `;
                bankCardsContainer.appendChild(card);
            });
        }

        // Render bank options in selects
        function renderBankOptions() {
            const bankSelects = [incomeBank, expenseBank, fromBank, toBank, filterBank];
            
            bankSelects.forEach(select => {
                // Clear existing options except the first one (if it's a placeholder)
                if (select.id !== 'filterBank' && select.id !== 'filterType' && select.id !== 'filterCategory') {
                    select.innerHTML = '';
                } else if (select.id === 'filterBank') {
                    // Keep the "Todos los bancos" option
                    select.innerHTML = '<option value="">Todos los bancos</option>';
                }
                
                banks.forEach(bank => {
                    const option = document.createElement('option');
                    option.value = bank.id;
                    option.textContent = bank.name;
                    select.appendChild(option);
                });
            });
        }

        // Render expense categories
        function renderExpenseCategories() {
            expenseCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                expenseCategory.appendChild(option);
                
                // Also add to filter
                const filterOption = document.createElement('option');
                filterOption.value = category;
                filterOption.textContent = category;
                filterCategory.appendChild(filterOption);
            });
        }

        // Render reconciliation table
        function renderReconciliationTable() {
            reconciliationBody.innerHTML = '';
            banks.forEach(bank => {
                const row = document.createElement('tr');
                row.className = 'fade-in';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-200">${bank.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${formatCurrency(bank.balance)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="number" data-bank="${bank.id}" class="real-balance w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" placeholder="Ingrese saldo real">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300 discrepancy" data-bank="${bank.id}">$0</td>
                `;
                reconciliationBody.appendChild(row);
            });
        }

        // Render transaction history
        function renderTransactionHistory(filterBankValue = '', filterTypeValue = '', filterCategoryValue = '') {
            transactionHistory.innerHTML = '';
            
            // Filter transactions
            let filteredTransactions = transactions.filter(transaction => {
                const matchesBank = !filterBankValue || 
                    (transaction.type === 'transfer' 
                        ? (transaction.fromBank === filterBankValue || transaction.toBank === filterBankValue)
                        : transaction.bank === filterBankValue);
                
                const matchesType = !filterTypeValue || transaction.type === filterTypeValue;
                const matchesCategory = !filterCategoryValue || transaction.category === filterCategoryValue;
                
                return matchesBank && matchesType && matchesCategory;
            });
            
            // Sort by date (newest first)
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredTransactions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-300">
                        No hay movimientos que coincidan con los filtros
                    </td>
                `;
                transactionHistory.appendChild(row);
                return;
            }
            
            filteredTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'fade-in';
                
                let typeText, typeColor, bankName, categoryText, amountText;
                
                // Determine transaction type display
                if (transaction.type === 'income') {
                    typeText = 'Ingreso';
                    typeColor = 'text-green-600 dark:text-green-300';
                    bankName = banks.find(b => b.id === transaction.bank)?.name || transaction.bank;
                    amountText = `<span class="text-green-600 dark:text-green-300">+${formatCurrency(transaction.amount)}</span>`;
                } else if (transaction.type === 'expense') {
                    typeText = 'Gasto';
                    typeColor = 'text-red-600 dark:text-red-300';
                    bankName = banks.find(b => b.id === transaction.bank)?.name || transaction.bank;
                    amountText = `<span class="text-red-600 dark:text-red-300">-${formatCurrency(transaction.amount)}</span>`;
                } else if (transaction.type === 'transfer') {
                    typeText = 'Transferencia';
                    typeColor = 'text-purple-600 dark:text-purple-300';
                    const fromBankName = banks.find(b => b.id === transaction.fromBank)?.name || transaction.fromBank;
                    const toBankName = banks.find(b => b.id === transaction.toBank)?.name || transaction.toBank;
                    bankName = `${fromBankName} → ${toBankName}`;
                    amountText = `<span class="text-purple-600 dark:text-purple-300">-${formatCurrency(transaction.amount)}</span>`;
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${formatDate(transaction.date)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${typeColor}">${typeText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${bankName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${transaction.category || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300">${transaction.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${amountText}</td>
                `;
                transactionHistory.appendChild(row);
            });
        }

        // Update summary totals
        function updateSummary() {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const totalBalance = totalIncome - totalExpenses;
            
            totalIncomeElement.textContent = formatCurrency(totalIncome);
            totalExpensesElement.textContent = formatCurrency(totalExpenses);
            totalBalanceElement.textContent = formatCurrency(totalBalance);
            
            updateCharts();
        }

        // Initialize charts
        function initCharts() {
            const fundsCtx = document.getElementById('fundsDistributionChart').getContext('2d');
            const incomeExpenseCtx = document.getElementById('incomeExpenseChart').getContext('2d');
            
            fundsDistributionChart = new Chart(fundsCtx, {
                type: 'doughnut',
                data: {
                    labels: banks.map(b => b.name),
                    datasets: [{
                        data: banks.map(b => b.balance),
                        backgroundColor: [
                            '#0033A0', '#00B5E2', '#FF6B00', '#E31937', 
                            '#6CC24A', '#A45DB6', '#FFD700'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#6B7280'
                            }
                        }
                    }
                }
            });
            
            // Group transactions by month for income/expense chart
            const monthlyData = groupTransactionsByMonth();
            
            incomeExpenseChart = new Chart(incomeExpenseCtx, {
                type: 'bar',
                data: {
                    labels: monthlyData.labels,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: monthlyData.income,
                            backgroundColor: '#10B981',
                            borderColor: '#10B981',
                            borderWidth: 1
                        },
                        {
                            label: 'Gastos',
                            data: monthlyData.expenses,
                            backgroundColor: '#EF4444',
                            borderColor: '#EF4444',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            stacked: false,
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6B7280'
                            }
                        },
                        y: {
                            stacked: false,
                            ticks: {
                                color: '#6B7280',
                                callback: function(value) {
                                    return formatCurrencyShort(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#6B7280'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatCurrency(context.raw);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update charts with current data
        function updateCharts() {
            // Update funds distribution chart
            fundsDistributionChart.data.datasets[0].data = banks.map(b => b.balance);
            fundsDistributionChart.update();
            
            // Update income/expense chart
            const monthlyData = groupTransactionsByMonth();
            incomeExpenseChart.data.labels = monthlyData.labels;
            incomeExpenseChart.data.datasets[0].data = monthlyData.income;
            incomeExpenseChart.data.datasets[1].data = monthlyData.expenses;
            incomeExpenseChart.update();
        }

        // Group transactions by month for the income/expense chart
        function groupTransactionsByMonth() {
            const result = {
                labels: [],
                income: [],
                expenses: []
            };
            
            // Get unique months from transactions
            const months = [...new Set(transactions.map(t => {
                const date = new Date(t.date);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }))].sort();
            
            months.forEach(month => {
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleDateString('es-CO', { month: 'short', year: 'numeric' });
                result.labels.push(monthName);
                
                const monthTransactions = transactions.filter(t => {
                    const date = new Date(t.date);
                    return date.getFullYear() == year && String(date.getMonth() + 1).padStart(2, '0') == monthNum;
                });
                
                const income = monthTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const expenses = monthTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                result.income.push(income);
                result.expenses.push(expenses);
            });
            
            return result;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Filter transactions
            filterBank.addEventListener('change', () => {
                renderTransactionHistory(filterBank.value, filterType.value, filterCategory.value);
            });
            
            filterType.addEventListener('change', () => {
                renderTransactionHistory(filterBank.value, filterType.value, filterCategory.value);
            });
            
            filterCategory.addEventListener('change', () => {
                renderTransactionHistory(filterBank.value, filterType.value, filterCategory.value);
            });
            
            // Register income
            incomeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const bankId = incomeBank.value;
                const amount = parseFloat(incomeAmount.value);
                const description = incomeDescription.value;
                
                if (!bankId || isNaN(amount) || amount <= 0 || !description) {
                    alert('Por favor complete todos los campos correctamente');
                    return;
                }
                
                // Find the bank and update balance
                const bank = banks.find(b => b.id === bankId);
                if (bank) {
                    bank.balance += amount;
                    
                    // Add transaction
                    const newTransaction = {
                        id: transactions.length + 1,
                        date: new Date().toISOString().split('T')[0],
                        type: 'income',
                        bank: bankId,
                        amount: amount,
                        description: description,
                        category: ''
                    };
                    
                    transactions.push(newTransaction);
                    
                    // Update UI
                    renderBankCards();
                    renderTransactionHistory(filterBank.value, filterType.value, filterCategory.value);
                    updateSummary();
                    
                    // Reset form
                    incomeForm.reset();
                }
            });
            
            // Register expense
            expenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const bankId = expenseBank.value;
                const amount = parseFloat(expenseAmount.value);
                const category = expenseCategory.value;
                const description = expenseDescription.value;
                
                if (!bankId || isNaN(amount) || amount <= 0 || !category) {
                    alert('Por favor complete todos los campos correctamente');
                    return;
                }
                
                // Find the bank and update balance
                const bank = banks.find(b => b.id === bankId);
                if (bank) {
                    if (bank.balance < amount) {
                        alert('Saldo insuficiente en esta cuenta');
                        return;
                    }
                    
                    bank.balance -= amount;
                    
                    // Add transaction
                    const newTransaction = {
                        id: transactions.length + 1,
                        date: new Date().toISOString().split('T')[0],
                        type: 'expense',
                        bank: bankId,
                        amount: amount,
                        description: description || category,
                        category: category
                    };
                    
                    transactions.push(newTransaction);
                    
                    // Update UI
                    renderBankCards();
                    renderTransactionHistory(filterBank.value, filterType.value, filterCategory.value);
                    updateSummary();
                    
                    // Reset form
                    expenseForm.reset();
                }
            });
            
            // Register transfer
            transferForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const fromBankId = fromBank.value;
                const toBankId = toBank.value;
                const amount = parseFloat(transferAmount.value);
                const description = transferDescription.value;
                
                if (!fromBankId || !toBankId || fromBankId === toBankId || isNaN(amount) || amount <= 0) {
                    alert('Por favor complete todos los campos correctamente');
                    return;
                }
                
                // Find the banks
                const fromBankAccount = banks.find(b => b.id === fromBankId);
                const toBankAccount = banks.find(b => b.id === toBankId);
                
                if (fromBankAccount && toBankAccount) {
                    if (fromBankAccount.balance < amount) {
                        alert('Saldo insuficiente en la cuenta de origen');
                        return;
                    }
                    
                    // Update balances
                    fromBankAccount.balance -= amount;
                    toBankAccount.balance += amount;
                    
                    // Add transaction
                    const newTransaction = {
                        id: transactions.length + 1,
                        date: new Date().toISOString().split('T')[0],
                        type: 'transfer',
                        fromBank: fromBankId,
                        toBank: toBankId,
                        amount: amount,
                        description: description || `Transferencia a ${toBankAccount.name}`,
                        category: ''
                    };
                    
                    transactions.push(newTransaction);
                    
                    // Update UI
                    renderBankCards();
                    renderTransactionHistory(filterBank.value, filterType.value, filterCategory.value);
                    updateSummary();
                    
                    // Reset form
                    transferForm.reset();
                }
            });
            
            // Calculate discrepancy
            calculateDiscrepancy.addEventListener('click', () => {
                const realBalanceInputs = document.querySelectorAll('.real-balance');
                
                realBalanceInputs.forEach(input => {
                    const bankId = input.dataset.bank;
                    const realBalance = parseFloat(input.value) || 0;
                    const bank = banks.find(b => b.id === bankId);
                    
                    if (bank) {
                        const discrepancy = realBalance - bank.balance;
                        const discrepancyElement = document.querySelector(`.discrepancy[data-bank="${bankId}"]`);
                        
                        discrepancyElement.textContent = formatCurrency(discrepancy);
                        
                        if (discrepancy > 0) {
                            discrepancyElement.classList.add('text-green-600', 'dark:text-green-300');
                            discrepancyElement.classList.remove('text-red-600', 'dark:text-red-300');
                        } else if (discrepancy < 0) {
                            discrepancyElement.classList.add('text-red-600', 'dark:text-red-300');
                            discrepancyElement.classList.remove('text-green-600', 'dark:text-green-300');
                        } else {
                            discrepancyElement.classList.remove('text-green-600', 'dark:text-green-300', 'text-red-600', 'dark:text-red-300');
                        }
                    }
                });
            });
        }

        // Helper functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(amount);
        }

        function formatCurrencyShort(amount) {
            if (amount >= 1000000) {
                return `$${(amount / 1000000).toFixed(1)}M`;
            } else if (amount >= 1000) {
                return `$${(amount / 1000).toFixed(1)}K`;
            }
            return `$${amount}`;
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('es-CO', options);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);

        // Prevent default anchor behavior
        document.querySelectorAll('a').forEach(anchor => {
            anchor.addEventListener('click', e => {
                e.preventDefault();
                // You can add custom navigation logic here if needed
            });
        });
    </script>
</body>
</html>
